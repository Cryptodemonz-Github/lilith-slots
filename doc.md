# CryptoDemonz, Slot machine 

## resultOf
It returns with the winning combination of player. Left, center and right refer to the position of random number on reelset. 
``` javascript
function resultOf(address player) external view returns (uint256[] memory) {
        uint256[] memory result = new uint256[](3);

        result[0] = results[addressToRequestId[player]].left;
        result[1] = results[addressToRequestId[player]].center;
        result[2] = results[addressToRequestId[player]].right;

        return result;
    }
```

## getRandomNumber
It asks for a random number from Chainlink with calling Chainlink's requestRandomness function. RequestId and user's address stored in mappings, seperately in directions. RequestId is emitted for the front-end by an event.
``` javascript
    function getRandomNumber(address player) public {
        require(LINK.balanceOf(address(this)) >= fee, "Not enough LINK.");
        bytes32 requestId = requestRandomness(keyHash, fee);
        addressToRequestId[player] = requestId;
        requestIdToAddress[requestId] = player;

        emit RequestIdIsCreated(player, requestId);
    }
```

## fulfillRandomness
It's an overriden Chainlink callback function, called when random number is received when verified. It creates 2 more random numbers out of that 1 verified random number that is generated by Chainlink. It stores the 3 random number as a Combination struct in a mapping where requestId is the key. When these 3 random numbers a generated, this function calls the prize calculator funtion and emits the random numbers for the front-end by an event.   
``` javascript
function fulfillRandomness(bytes32 requestId, uint256 randomness)
        internal
        override
    {
        uint256[] memory randomNumbers = new uint256[](3);
        uint256 randomNumber = (randomness %
            (maxSymbolValue.add(1) - minSymbolValue)) + minSymbolValue; // random number between 1 and 6
        randomNumbers[0] = randomNumber;

        // getting 2 more random numbers out of 1 truly random
        for (uint256 i = 1; i < randomNumbers.length; i++) {
            randomNumbers[i] = uint256(
                (uint256(keccak256(abi.encode(randomNumber, i))) %
                    (maxSymbolValue.add(1) - minSymbolValue)) + minSymbolValue
            );
        }
        requestIdToRandomNumbers[requestId] = randomNumbers;
        Combination memory result = Combination(
            randomNumbers[0],
            randomNumbers[1],
            randomNumbers[2]
        );
        results[requestId] = result;

        calculatePrize(requestId);

        emit RandomsAreArrived(requestId, randomNumbers);
    }
```

# calculatePrize
The ruleset is implemented in this function. You can read more about the ruleset in the README.md document. It investigates the ruleset with the generated random numbers. If there's equality, it sends the prize defined in the ruleset. 
``` javascript
function calculatePrize(bytes32 requestId) internal {
        require(
            requestIdToAddress[requestId] != address(0),
            "Player cannot be null address."
        );
        address player = requestIdToAddress[requestId];

        // 6-6-6
        // --> Pays: 20x
        if (
            results[requestId].left == 6 &&
            results[requestId].center == 6 &&
            results[requestId].right == 6
        ) {
            _LLTH.transfer(player, bets[player].mul(multiplier.first));

            emit PrizeOfPlayer(requestId, bets[player].mul(multiplier.first));
        }
        // 5-5-5, 4-4-4, 3-3-3, 2-2-2, 1-1-1
        // --> Pays: 5x
        else if (
            results[requestId].left == results[requestId].center &&
            results[requestId].left == results[requestId].right &&
            results[requestId].left != 6
        ) {
            _LLTH.transfer(player, bets[player].mul(multiplier.second));

            emit PrizeOfPlayer(requestId, bets[player].mul(multiplier.second));
        }
        // 6-6-x, 6-x-6, x-6-6
        // --> Pays: 4x
        else if (
            (results[requestId].left == 6 &&
                results[requestId].center == 6 &&
                results[requestId].right != 6) ||
            // ----------------------------------
            (results[requestId].left == 6 &&
                results[requestId].center != 6 &&
                results[requestId].right == 6) ||
            // ----------------------------------
            (results[requestId].left != 6 &&
                results[requestId].center == 6 &&
                results[requestId].right == 6)
        ) {
            _LLTH.transfer(player, bets[player].mul(multiplier.third));

            emit PrizeOfPlayer(requestId, bets[player].mul(multiplier.third));
        }
        // 6-x-x, x-6-x, x-x-6
        // --> Pays: 1x
        else if (
            (results[requestId].left == 6 &&
                results[requestId].center != 6 &&
                results[requestId].right != 6) ||
            // ----------------------------------
            (results[requestId].left != 6 &&
                results[requestId].center == 6 &&
                results[requestId].right != 6) ||
            // ----------------------------------
            (results[requestId].left != 6 &&
                results[requestId].center != 6 &&
                results[requestId].right == 6)
        ) {
            _LLTH.transfer(player, bets[player].mul(multiplier.fourth));

            emit PrizeOfPlayer(requestId, bets[player].mul(multiplier.fourth));
        } else {
            emit PrizeOfPlayer(requestId, 0);
        }
    }
```

## placeBet
This function is called by the front-end when the user decides to place a bet.
``` javascript
function placeBet() external {
        _LLTH.transferFrom(msg.sender, address(this), betAmount);
        bets[msg.sender] = betAmount;
        getRandomNumber(msg.sender);
    }
```

## withdraw
By calling this function, the owner account can withdraw the amount given as input from the contract's LLTH balance.
``` javascript
function withdraw(uint256 amount) external onlyOwner {
        require(_LLTH.balanceOf(address(this)) >= amount);
        require(
            betAmount <= _LLTH.balanceOf(address(this)),
            "Not enough LLTH in game's wallet to play."
        );

        _LLTH.transfer(owner(), amount);
    }
```
